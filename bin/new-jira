#!/usr/bin/env bash
# This script expects you to have a ~/.jira_credentials file with the following
# contents:
# ```yaml
# user: "<your canonical email address>"
# token: "<a valid Jira API token>"
# board_id: <integer board id>
# sprint_prefix: "<string prefix for you Jira pulse names>"  # e.g. "(Apps)"
# ```
#
# See here for details of how to obtain a Jira API token:
# https://developer.atlassian.com/cloud/jira/platform/basic-auth-for-rest-apis/
#
# Usage:
#   ./new-jira Story Flutter "My awesome Jira issue"

function description_from_editor {
  fname=$(mktemp) || exit 1
  echo "Write your issue details here" >"$fname"
  "$EDITOR" "$fname" </dev/tty >/dev/tty  # make sure that we have a TTY to work with for the editor
  cat "$fname"
  rm "$fname"
}

ISSUE_TYPE="$1"
COMPONENT="$2"
shift 2
SUMMARY="$*"
DESCRIPTION="$(description_from_editor)"
USER="$(grep user ~/.jira_credentials | cut -d' ' -f2 | tr -d '"')"
TOKEN="$(grep token ~/.jira_credentials | cut -d' ' -f2 | tr -d '"')"
PREFIX="$(grep sprint_prefix ~/.jira_credentials | cut -d' ' -f2 | tr -d '"')"
BOARD_ID="$(grep board_id ~/.jira_credentials | cut -d' ' -f2)"

echo "  Project: UDENG"
echo "  Summary: $SUMMARY"
echo "  Type: $ISSUE_TYPE"
echo "  Component: $COMPONENT"
echo -e "  Description:\n$DESCRIPTION"

echo -e "\n>>> Create a new issue with these details? [y/n]"
read -r confirm; echo
[ "$confirm" = "y" ] || exit

echo ">>> Creating issue..."
DATA=$(jq -n \
  --arg summary "$SUMMARY" \
  --arg description "$DESCRIPTION" \
  --arg issue_type "$ISSUE_TYPE" \
  --arg component "$COMPONENT" \
  '{
    "fields": {
      "project": {"key": "UDENG"},
      "summary": $summary,
      "description": $description,
      "issuetype": {"name": $issue_type},
      "components": [{"name": $component}]
    }
  }'
)

SPRINTS="$(
  curl -s \
    "https://warthogs.atlassian.net/rest/agile/1.0/board/$BOARD_ID/sprint?state=active" \
    -H 'Content-type: application/json' \
    -H 'Accept: application/json' \
    -u "$USER:$TOKEN" |
      jq -r "
        .values |
        map(select(.originBoardId == $BOARD_ID)) |
        map(select(.name | startswith(\"$PREFIX\")))
      "
)"

SPRINT_IDS="$(echo "$SPRINTS" | jq -r '. | map(.id) | join("\n")')"
if [[ "$(echo "$SPRINT_IDS" | wc -l)" -ne 1 ]]; then
  echo -e ">>> Ambiguous sprint IDs. Exiting\n$SPRINTS"
  exit 1
fi

SPRINT_ID="$(echo "$SPRINT_IDS" | head -n1)"
KEY="$(
  curl -s \
    'https://warthogs.atlassian.net/rest/api/2/issue' \
    -H 'Content-type: application/json' \
    -u "$USER:$TOKEN" \
    --data "$DATA" |
      jq -r '.key'
)"

curl -s \
  "https://warthogs.atlassian.net/rest/agile/1.0/sprint/$SPRINT_ID/issue" \
  -H 'Content-type: application/json' \
  -H 'Accept: application/json' \
  -u "$USER:$TOKEN" \
  --data "{\"issues\": [\"$KEY\"]}"

echo ">>> Issue created and added to active pulse: $KEY"
