name: GH Token permission warnings
description: Checks if the GitHub token provided has too many permissions
inputs:
  token:
    description: The token to check for permissions
    required: true
  fail-for-push:
    description: The token cannot be used to push commits to the repo
    default: 'true'
  fail-for-pr:
    description: The token cannot create or modify pull requests
    default: 'true'
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
      id: my-checkout
      if: ${{ inputs.fail-for-push != 'false' }}
      continue-on-error: true
      with:
        path: '.source-checkout-${{ github.run_id }}'
        ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
        token: ${{ inputs.token }}
    - name: Check token has no contents:write permission
      id: check_push
      if: ${{ inputs.fail-for-push != 'false' && steps.my-checkout.outputs.ref != '' }}
      continue-on-error: true
      shell: bash --noprofile --norc -euo pipefail {0}
      working-directory: '.source-checkout-${{ github.run_id }}'
      env:
        GH_TOKEN: ${{ inputs.token }}
        REPO_PATH: ${{ github.repository }}
        NEW_BRANCH: ${{ format('check_push-deleteme-{0}_{1}', github.run_id, github.sha) }}
      run: |
        # Check token has no contents:write permission
        echo "::group::Check token has no contents:write permission"
        git config user.name github-actions[bot]
        git config user.email github-actions[bot]@users.noreply.github.com
        git checkout -b "${NEW_BRANCH}"
        git commit --allow-empty -m "DropMe: Pushing this commit should not work"
        # Push just works because we checkout with `persist-credentials: true` (the default
        # behaviour).
        git push --set-upstream origin "${NEW_BRANCH}" || success=false
        echo "::endgroup::" # Close the group first so that the error message is visible.
        if [ "${success:-}" != false ]; then
          echo "::error::'token' has 'contents:write' permission, but it should be 'none' or 'read'."
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "branch-to-cleanup=$NEW_BRANCH" >> $GITHUB_OUTPUT
          exit 1
        fi
    - name: Clean up temporary branch
      working-directory: '.source-checkout-${{ github.run_id }}'
      shell: bash --noprofile --norc -euo pipefail {0}
      if: ${{ steps.check_push.outputs.status == 'failed' }}
      env:
        NEW_BRANCH: ${{ steps.check_push.outputs.branch-to-cleanup }}
      run: git push --delete "${NEW_BRANCH}"
    - name: Clean up temporary checkout
      shell: bash --noprofile --norc -euo pipefail {0}
      if: always()
      continue-on-error: true
      run: |
        # Clean up temporary checkout
        rm -rf '.source-checkout-${{ github.run_id }}'
    - name: Check token has no pull-requests:write permission
      # Only applicable on pull requests.
      if: ${{ inputs.fail-for-pr != 'false' && github.event_name == 'pull_request' }}
      id: check_pr
      continue-on-error: true
      shell: bash --noprofile --norc -euo pipefail {0}
      env:
        GH_TOKEN: ${{ inputs.token }}
      run: |
        # Check token has no pull-requests:write permission
        echo "::group::Check token has no pull-requests:write permission"
        gh pr comment -b "You should restrict the github token permissions of the '${{ github.job }}' job (ideally to none - 'permissions: {}')" ${{ github.event.pull_request.number }} \
         || success=false
        echo "::endgroup::" # Close the group first so that the error message is visible.
        if [ "${success:-}" != false ]; then
          echo "::error::'token' has 'pull-requests:write' permission, but it should be 'none' or 'read'."
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
    - name: Fail
      if: steps.check_push.outputs.status == 'failed' || steps.check_pr.outputs.status == 'failed'
      shell: bash --noprofile --norc -euo pipefail {0}
      run: |
        echo "::warning::Consider setting your job's permissions to none ('permissions: {}') or to the minimum scope needed."
        exit 1
